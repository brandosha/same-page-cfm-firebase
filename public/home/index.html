<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Same Page">
    <meta name="apple-mobile-web-app-status-bar-style" content="white">
    <title>Home</title>

    <!-- update the version number as needed -->
    <script defer src="/__/firebase/6.3.5/firebase-app.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/6.3.5/firebase-auth.js"></script>
    <script defer src="/__/firebase/6.3.5/firebase-firestore.js"></script>
    <script defer src="/__/firebase/6.3.5/firebase-functions.js"></script>
    <script defer src="/__/firebase/6.3.5/firebase-storage.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>
    
    <script src="/resources/consoleReplace.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
    <script src="/resources/loader.js"></script>
    <script src="/resources/scriptures.js"></script>
    <script src="/resources/FirebaseHandler.js"></script>
    <script src="/resources/fullPageLinkHandling.js"></script>
    <script src="/sw.js"></script>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="/resources/avatar.css">
    <link rel="stylesheet" href="/resources/loader.css">
    <link rel="stylesheet" href="/resources/dark.css">
    <link rel="stylesheet" href="style.css">
</head>
  <body>
    <div id="vue-main" class="container-fluid p-0 window-height">
      <div class="row" v-if='!noGroups'>
        <nav class="fixed-top container-fluid">
          <div class="row">
            <div
              id="group-toolbar"
              class="d-sm-flex p-1 align-items-center justify-content-between col-sm-4"
              :class="isValidGroup ? 'd-none' : 'd-flex'"
            >
              <div>
                <span class="invisible nav-link h5 m-0" href="#">
                  &#9664;
                </span>
              </div>
              <div class="text-dark h5 m-0 text-capitalize">
                  Groups
              </div>
              <div class="dropdown">
                <a
                  class="nav-link text-dark h4 m-0"
                  data-toggle="dropdown"
                  href="#"
                  @click.prevent
                >&#8943;</a>
                <div class="dropdown-menu">
                  <a
                    class="dropdown-item"
                    :class="disabledIfOffline"
                    href="/create-group"
                  >Create group</a>
                  <a
                    class="dropdown-item"
                    :class="disabledIfOffline"
                    href="/profile"
                  >Profile</a>
                </div>
              </div>
            </div>
            <div
              v-if="isValidGroup"
              id="group-toolbar"
              class="d-flex p-1 align-items-center justify-content-between col-sm-8"
            >
              <div>
                <a
                  class="nav-link text-dark h5 m-0 d-xs-block d-sm-none" 
                  href="#"
                >&#9664;</a>
              </div>
              <div class="text-dark h5 m-0 d-xs-block d-sm-none text-capitalize">
                {{ firebaseData.groups[groupId].name }}
              </div>
              <div class="dropdown">
                <a
                  class="nav-link text-dark h4 m-0"
                  data-toggle="dropdown"
                  href="#"
                  @click.prevent
                >&#8943;</a>
                <div class="dropdown-menu">
                  <a
                    class="dropdown-item"
                    :class="disabledIfOffline"
                    :href="'/group-settings/#'+groupId"
                  >Group settings</a>
                </div>
              </div>
            </div>
          </div>
        </nav>
        <div id="group-list" class="col-sm-4 pr-0 border-right border-dark window-height" :class="{ 'd-none d-sm-block': isValidGroup }">
          <transition-group name="group-list" tag="div">
          <div v-for="group in firebaseData.groupArr" :key="group.id" class="group-list-item">
            <a class="btn w-100 border-bottom group-btn px-3 py-1" :class="groupId === group.id ? 'btn-light' : 'btn-dark'" :href="'#'+group.id">
              <span class="h5 text-capitalize">{{ group.name }}</span>
              <div class="text-truncate">
                {{ formatMessage(group.lastMessage) }}
              </div>
            </a>
          </div>
          </transition-group>
        </div>
        <div class="col-sm-8" v-if="isValidGroup">
          <div id="messages" class="container window-height">
            <div
              v-for="(message, index) in firebaseData.groups[groupId].messagesArr"
              v-if="message !== undefined"
              class="py-1"
            >
              <div v-if="shouldAddDate(index)" class="date" v-html="formatDate(index)"></div>
              <div class="d-flex align-items-center justify-content-between message-row" :class="{ 'flex-row-reverse': message.from === firebaseData.uid }">
                <div class="d-flex align-items-center message-container" :class="{ 'flex-row-reverse': message.from === firebaseData.uid }">
                  <img
                    v-if="firebaseData.users[message.from].avatar"
                    class="avatar"
                    :src="firebaseData.users[message.from].avatar"
                    :alt="firebaseData.users[message.from].name"
                    :class="message.from === firebaseData.uid ? 'ml-2' : 'mr-2'"
                  >
                  <div
                    v-else
                    class="avatar text-monospace"
                    :class="message.from === firebaseData.uid ? 'ml-2' : 'mr-2'"
                  >{{ initials(message) }}</div>
    
                  <div
                    v-html="message.html"
                    class="message m-0"
                    :class="message.from === firebaseData.uid ? 'message-from-me' : 'message-from-other'"
                  ></div>
                </div>
                <div class="text-center d-flex align-items-center" :class="{ 'flex-row-reverse': message.from === firebaseData.uid }">
                  <div class="timestamp text-monospace d-inline-block mx-1" v-html="formatTime(message)"></div>
                  <div
                    v-if="message.from === firebaseData.uid || firebaseData.groups[groupId].members[firebaseData.uid].isManager"
                    class="dropdown"
                  >
                    <a
                      class="message-options text-dark nav-link p-0"
                      data-toggle="dropdown"
                      href="#"
                      @click.prevent
                    >
                      &nbsp;&#8943;
                    </a>
                    <div class="dropdown-menu">
                      <a
                        class="dropdown-item text-danger"
                        href="#"
                        @click.prevent="deleteMessage(message)"
                      >Delete</a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="container-fluid fixed-bottom" style="pointer-events: none;">
            <div class="row">
              <div class="col-sm-4 invisible"></div>
              <div id="message-input" class="col-sm-8" style="pointer-events: auto;">
                <form @submit.prevent="sendMessage">
                  <div
                    class="row form-group align-items-center mx-0"
                    :class="fullPage ? 'mb-4' : 'mb-1'"
                  >
                    <textarea
                      type="text"
                      v-model="newMessage"
                      id="message-textarea"
                      class="form-control expand mx-3 col"
                      style="resize: none; max-height: 100px;"
                      :disabled="sendFormDisabled.input"
                      @keydown.enter="messageInputEnter"
                    ></textarea>
                    <div class="col-auto">
                      <input 
                        type="submit" 
                        value="Send" 
                        class="btn btn-primary w-100"
                        :disabled="sendFormDisabled.submit"
                      >
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
        <div class="col-sm-8 d-none d-sm-block" v-else>
          <div class="container pt-3">
            Select a group to begin
          </div>
        </div>
      </div>
      <div class='container' v-else>
        <div class="pt-3">
          <div class="display-4">It looks like you aren't a member of any groups.</div>
          <div class="lead mt-3">Ask a group manager to add you to their group or <a href="/create-group">create your own.</a></div>
        </div>
      </div>
    </div>

    <!-- <div id="debug">
      <div v-if="debugging" id="debug-body">
        <div id="debug-top" class="w-100 bg-light">
          <div id="debug-resize-control" class="w-100 d-flex justify-content-center align-items-center" style="height: 8px; background-color: gray">
            <div style="height: 2px; width: 30px; background-color: black"></div>
          </div>
          <form @submit.prevent='execute' class="container-fluid mt-2">
            <div class="row form-group">
              <input type="text" v-model="command" class="form-control text-monospace mx-2 col">
              <input type="submit" value="Execute" class="btn btn-primary mx-2 col-auto">
            </div>
          </form>
        </div>
        
        <div class="text-monospace border-bottom px-2" v-for="log in logs" :class="log.type">
          <pre class="d-inline">{{ log.text }}</pre>
        </div>
      </div>
    </div> -->

    <div id="loader" class="full-page-container">
      <div class="loader-container">
        <div class="d5"></div>
        <div class="d4"></div>
        <div class="d3"></div>
        <div class="d2"></div>
        <div class="d1"></div>
      </div>
    </div>

    <script defer src="main.js"></script>
  </body>
</html>
